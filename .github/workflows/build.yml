name: CI/CD

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

permissions:
  contents: write

jobs:
  # ──────────────────────────────────────────────
  # Lint & type-check (fast feedback)
  # ──────────────────────────────────────────────
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install frontend dependencies
        run: pnpm install

      - name: TypeScript check
        run: npx tsc --noEmit

      - name: ESLint
        run: pnpm lint

  # ──────────────────────────────────────────────
  # Frontend tests
  # ──────────────────────────────────────────────
  test-frontend:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install frontend dependencies
        run: pnpm install

      - name: Run tests
        run: pnpm test

  # ──────────────────────────────────────────────
  # Rust checks
  # ──────────────────────────────────────────────
  check-rust:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libgtk-3-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: cargo fmt check
        run: cargo fmt --check
        working-directory: src-tauri

      - name: cargo clippy
        run: cargo clippy -- -D warnings
        working-directory: src-tauri

      - name: cargo test
        run: cargo test
        working-directory: src-tauri

  # ──────────────────────────────────────────────
  # Build Tauri application
  # ──────────────────────────────────────────────
  build:
    runs-on: ubuntu-latest
    needs: [test-frontend, check-rust]
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libgtk-3-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install frontend dependencies
        run: pnpm install

      - name: Build Tauri app
        run: pnpm tauri build
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: List build artifacts
        run: |
          echo "=== All bundle artifacts ==="
          find src-tauri/target/release/bundle -type f | sort

      # ── Release creation (tag pushes only) ──
      - name: Create GitHub release and upload assets
        if: startsWith(github.ref, 'refs/tags/v')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          VERSION="${TAG#v}"
          BUNDLE="src-tauri/target/release/bundle"

          echo "Creating release for ${TAG} (version ${VERSION})..."

          # Collect release assets
          ASSETS=()
          while IFS= read -r f; do
            ASSETS+=("$f")
          done < <(find "${BUNDLE}" -name 'CleanOS-AI*' -type f | sort)

          # Filter out lowercase-named duplicates (Tauri v2 generates both cases)
          FILTERED=()
          for f in "${ASSETS[@]}"; do
            basename=$(basename "$f")
            if [[ "$basename" == clean-os-ai* ]]; then
              continue
            fi
            FILTERED+=("$f")
          done
          ASSETS=("${FILTERED[@]}")

          echo "Assets to upload:"
          printf '  %s\n' "${ASSETS[@]}"

          # Read the .AppImage.tar.gz.sig content for latest.json
          APPIMAGE_SIG_FILE="${BUNDLE}/appimage/CleanOS-AI_${VERSION}_amd64.AppImage.tar.gz.sig"
          if [ ! -f "$APPIMAGE_SIG_FILE" ]; then
            echo "ERROR: Signature file not found: ${APPIMAGE_SIG_FILE}"
            exit 1
          fi
          SIGNATURE=$(cat "$APPIMAGE_SIG_FILE")

          # Generate latest.json for the Tauri updater
          cat > latest.json <<LATESTEOF
          {
            "version": "${VERSION}",
            "notes": "CleanOS AI v${VERSION}",
            "pub_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "platforms": {
              "linux-x86_64": {
                "signature": "${SIGNATURE}",
                "url": "https://github.com/kryptobaseddev/cleanos-ai/releases/download/${TAG}/CleanOS-AI_${VERSION}_amd64.AppImage.tar.gz"
              }
            }
          }
          LATESTEOF

          # Remove leading whitespace from heredoc
          sed -i 's/^          //' latest.json

          echo "=== latest.json ==="
          cat latest.json

          ASSETS+=("latest.json")

          # Create the release (or upload to existing draft)
          if gh release view "$TAG" --repo "$GITHUB_REPOSITORY" &>/dev/null; then
            echo "Release ${TAG} exists, uploading assets..."
            gh release upload "$TAG" "${ASSETS[@]}" --repo "$GITHUB_REPOSITORY" --clobber
          else
            echo "Creating new release ${TAG}..."
            gh release create "$TAG" "${ASSETS[@]}" \
              --repo "$GITHUB_REPOSITORY" \
              --title "CleanOS AI v${VERSION}" \
              --notes "See the assets to download and install this version." \
              --draft
          fi

          echo "Release assets uploaded successfully."
