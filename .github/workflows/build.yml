name: CI/CD

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

permissions:
  contents: write

jobs:
  # ──────────────────────────────────────────────
  # Lint & type-check (fast feedback)
  # ──────────────────────────────────────────────
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install frontend dependencies
        run: pnpm install

      - name: TypeScript check
        run: npx tsc --noEmit

      - name: ESLint
        run: pnpm lint

  # ──────────────────────────────────────────────
  # Frontend tests
  # ──────────────────────────────────────────────
  test-frontend:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install frontend dependencies
        run: pnpm install

      - name: Run tests
        run: pnpm test

  # ──────────────────────────────────────────────
  # Rust checks
  # ──────────────────────────────────────────────
  check-rust:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libgtk-3-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: cargo fmt check
        run: cargo fmt --check
        working-directory: src-tauri

      - name: cargo clippy
        run: cargo clippy -- -D warnings
        working-directory: src-tauri

      - name: cargo test
        run: cargo test
        working-directory: src-tauri

  # ──────────────────────────────────────────────
  # Build Tauri application
  # ──────────────────────────────────────────────
  build:
    runs-on: ubuntu-latest
    needs: [test-frontend, check-rust]
    steps:
      - uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libwebkit2gtk-4.1-dev libgtk-3-dev libappindicator3-dev librsvg2-dev patchelf

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install frontend dependencies
        run: pnpm install

      - name: Build Tauri app
        run: pnpm tauri build
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: Sign bundles and create updater artifacts
        if: startsWith(github.ref, 'refs/tags/v')
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: |
          set -euo pipefail
          VERSION="${GITHUB_REF_NAME#v}"
          BUNDLE="src-tauri/target/release/bundle"

          DEB="${BUNDLE}/deb/CleanOS-AI_${VERSION}_amd64.deb"
          RPM="${BUNDLE}/rpm/CleanOS-AI-${VERSION}-1.x86_64.rpm"
          APPIMAGE="${BUNDLE}/appimage/CleanOS-AI_${VERSION}_amd64.AppImage"

          # Create .tar.gz of the AppImage for the updater
          echo "Creating AppImage tarball..."
          tar -czf "${APPIMAGE}.tar.gz" -C "$(dirname "$APPIMAGE")" "$(basename "$APPIMAGE")"

          # Sign all artifacts using tauri signer
          echo "Signing artifacts..."
          for artifact in "$DEB" "$RPM" "$APPIMAGE" "${APPIMAGE}.tar.gz"; do
            echo "  Signing $(basename "$artifact")..."
            pnpm tauri signer sign "$artifact" \
              --private-key "$TAURI_SIGNING_PRIVATE_KEY" \
              --password "$TAURI_SIGNING_PRIVATE_KEY_PASSWORD"
          done

          echo "=== Signed artifacts ==="
          find "${BUNDLE}" -name 'CleanOS-AI*' -type f | sort

      # ── Release creation (tag pushes only) ──
      - name: Create GitHub release and upload assets
        if: startsWith(github.ref, 'refs/tags/v')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          TAG="${GITHUB_REF_NAME}"
          VERSION="${TAG#v}"
          BUNDLE="src-tauri/target/release/bundle"

          echo "Creating release for ${TAG} (version ${VERSION})..."

          DEB="${BUNDLE}/deb/CleanOS-AI_${VERSION}_amd64.deb"
          RPM="${BUNDLE}/rpm/CleanOS-AI-${VERSION}-1.x86_64.rpm"
          APPIMAGE="${BUNDLE}/appimage/CleanOS-AI_${VERSION}_amd64.AppImage"

          # Build explicit list of release assets
          ASSETS=(
            "$DEB"
            "$DEB.sig"
            "$RPM"
            "$RPM.sig"
            "$APPIMAGE"
            "$APPIMAGE.sig"
            "${APPIMAGE}.tar.gz"
            "${APPIMAGE}.tar.gz.sig"
          )

          # Verify all assets exist
          for f in "${ASSETS[@]}"; do
            if [ ! -f "$f" ]; then
              echo "ERROR: Missing asset: $f"
              exit 1
            fi
            echo "  OK: $(basename "$f") ($(stat -c%s "$f") bytes)"
          done

          # Read the .AppImage.tar.gz.sig content for latest.json
          SIGNATURE=$(cat "${APPIMAGE}.tar.gz.sig")

          # Generate latest.json for the Tauri updater
          cat > latest.json <<EOF
          {
            "version": "${VERSION}",
            "notes": "CleanOS AI v${VERSION}",
            "pub_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "platforms": {
              "linux-x86_64": {
                "signature": "${SIGNATURE}",
                "url": "https://github.com/kryptobaseddev/cleanos-ai/releases/download/${TAG}/CleanOS-AI_${VERSION}_amd64.AppImage.tar.gz"
              }
            }
          }
          EOF
          sed -i 's/^          //' latest.json

          echo "=== latest.json ==="
          cat latest.json

          ASSETS+=("latest.json")

          # Create the release
          echo "Creating release ${TAG}..."
          gh release create "$TAG" "${ASSETS[@]}" \
            --repo "$GITHUB_REPOSITORY" \
            --title "CleanOS AI v${VERSION}" \
            --notes "See the assets to download and install this version."

          echo "Release created and assets uploaded successfully."
